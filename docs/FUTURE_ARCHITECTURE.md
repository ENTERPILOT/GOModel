# Future Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    INGRESS LAYER                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│   │   /v1/*     │  │  /p/{prov}  │  │  /admin     │  │  /health    │  │  /metrics   │   │
│   │  OpenAI API │  │ Pass-Through│  │  Admin API  │  │  Liveness   │  │ Prometheus  │   │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────────────┘  └─────────────┘   │
│          │                │                │                                            │
└──────────┼────────────────┼────────────────┼────────────────────────────────────────────┘
           │                │                │
           ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 AUTHENTICATION LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐                      │
│   │   API Key Auth   │  │   Session Auth   │  │    SSO/OIDC      │                      │
│   │  (Bearer token)  │  │  (Cookie/JWT)    │  │   (OAuth 2.0)    │                      │
│   │   gm_live_xxx    │  │   /admin/*       │  │   /auth/sso/*    │                      │
│   └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘                      │
│            │                     │                     │                                │
│            └─────────────────────┴─────────────────────┘                                │
│                                  │                                                      │
│                                  ▼                                                      │
│                     ┌────────────────────────┐                                          │
│                     │  Identity Resolution   │                                          │
│                     │  Key→User→Team→Org     │                                          │
│                     └────────────────────────┘                                          │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  POLICY ENGINE                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │
│   │ Rate Limit  │  │   Budget    │  │   Model     │  │  Guardrail  │                    │
│   │   Check     │  │   Check     │  │  Allowlist  │  │  Selection  │                    │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                    │
│          │                │                │                │                           │
│          └────────────────┴────────────────┴────────────────┘                           │
│                                  │                                                      │
│                    ┌─────────────┴─────────────┐                                        │
│                    │     Policy Decision       │                                        │
│                    │   ALLOW / DENY / WARN     │                                        │
│                    └───────────────────────────┘                                        │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                               GUARDRAILS PIPELINE                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                           PRE-PROCESSING (Input)                                │   │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │   │
│   │  │ Sys. Prompt  │  │ PII Detect   │  │ Injection    │  │ Custom Rules │         │   │
│   │  │ Decorator    │  │ & Anonymize  │  │ Detection    │  │ Provider &   │         │   │
│   │  │              │  │  (Ollama)    │  │              │  │Model Specific│         │   │
│   │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘         │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                               │
│                                         ▼                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                          POST-PROCESSING (Output)                               │   │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │   │
│   │  │  Content     │  │   JSON       │  │  PII Fill    │  │   Custom     │         │   │
│   │  │  Moderation  │  │   Schema     │  │  (Output)    │  │  Sanitizer   │         │   │
│   │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘         │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 ROUTING LAYER                                           │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌────────────────────┐          ┌────────────────────┐                                │
│   │   Model Registry   │◀────────▶│  Failover Config   │                                │
│   │  model → provider  │          │  gpt-5 → [gemini]  │                                │
│   └─────────┬──────────┘          └────────────────────┘                                │
│             │                                                                           │
│             ▼                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              Provider Router                                    │   │
│   │                                                                                 │   │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│   │  │  OpenAI  │ │Anthropic │ │  Gemini  │ │   Groq   │ │   xAI    │ │  Ollama  │  │   │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   DATA LAYER                                            │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                            Storage Abstraction                                  │   │
│   │                                                                                 │   │
│   │   Mode: SINGLE_INSTANCE              Mode: MULTI_INSTANCE                       │   │
│   │   ┌──────────────────────┐           ┌──────────────────────┐                   │   │
│   │   │  YAML + SQLite +     │           │  PostgreSQL +        │                   │   │
│   │   │  In-Memory Cache     │           │  Redis + MongoDB     │                   │   │
│   │   └──────────────────────┘           └──────────────────────┘                   │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │
│   │    Config     │  │   Identity    │  │    Usage      │  │  Audit Logs   │            │
│   │  (providers,  │  │  (keys,users  │  │  (tokens,$,   │  │  (who,what,   │            │
│   │   pricing)    │  │   teams,orgs) │  │   requests)   │  │   when)       │            │
│   └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘            │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```
