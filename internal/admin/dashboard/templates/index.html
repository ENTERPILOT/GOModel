{{define "index"}}
<!-- Overview Page -->
<div x-show="page==='overview'">
    <div class="page-header">
        <h2>Usage Overview</h2>
        <div class="page-header-controls">
            <div class="interval-picker">
                <button class="interval-btn" :class="{active: interval==='daily'}" @click="setInterval('daily')">Daily</button>
                <button class="interval-btn" :class="{active: interval==='weekly'}" @click="setInterval('weekly')">Weekly</button>
                <button class="interval-btn" :class="{active: interval==='monthly'}" @click="setInterval('monthly')">Monthly</button>
                <button class="interval-btn" :class="{active: interval==='yearly'}" @click="setInterval('yearly')">Yearly</button>
            </div>
            {{template "date-picker" .}}
        </div>
    </div>

    <!-- Auth Error Banner -->
    <div class="alert alert-warning" x-show="authError">
        Authentication required. Enter your API key in the sidebar to view data.
    </div>

    <!-- Summary Cards -->
    <div class="cards">
        <div class="card">
            <div class="card-label">Total Requests</div>
            <div class="card-value" x-text="formatNumber(summary.total_requests)">-</div>
        </div>
        <div class="card">
            <div class="card-label">Input Tokens</div>
            <div class="card-value" x-text="formatNumber(summary.total_input_tokens)">-</div>
        </div>
        <div class="card">
            <div class="card-label">Output Tokens</div>
            <div class="card-value" x-text="formatNumber(summary.total_output_tokens)">-</div>
        </div>
        <div class="card">
            <div class="card-label">Total Tokens</div>
            <div class="card-value" x-text="formatNumber(summary.total_tokens)">-</div>
        </div>
        <div class="card">
            <div class="card-label">Estimated Cost</div>
            <div class="card-value" x-text="formatCost(summary.total_cost)">-</div>
        </div>
    </div>

    <!-- Usage Chart -->
    <div class="chart-container">
        <h3 x-text="chartTitle()">Daily Token Usage</h3>
        <div class="chart-wrapper">
            <canvas id="usageChart"></canvas>
        </div>
        <p class="empty-state" x-show="daily.length === 0 && !loading && !authError">No usage data yet.</p>
    </div>
</div>

<!-- Usage Page -->
<div x-show="page==='usage'">
    <div class="page-header">
        <h2>Usage Analytics</h2>
        <div class="page-header-controls">
            <div class="usage-mode-toggle">
                <button class="usage-mode-btn" :class="{active: usageMode==='tokens'}" @click="toggleUsageMode('tokens')">Tokens</button>
                <button class="usage-mode-btn" :class="{active: usageMode==='costs'}" @click="toggleUsageMode('costs')">Costs</button>
            </div>
            {{template "date-picker" .}}
        </div>
    </div>

    <!-- Auth Error Banner -->
    <div class="alert alert-warning" x-show="authError">
        Authentication required. Enter your API key in the sidebar to view data.
    </div>

    <!-- Usage by Model Chart -->
    <div class="model-chart-section" x-show="modelUsage.length > 0">
        <h3 x-text="usageMode === 'tokens' ? 'Token Usage by Model' : 'Cost by Model'"></h3>
        <div class="bar-chart-wrap">
            <canvas id="usageBarChart"></canvas>
        </div>
    </div>

    <!-- Request Log Section -->
    <div class="usage-log-section">
        <h3>Request Log</h3>
        <div class="usage-log-toolbar">
            <input type="text" placeholder="Search by request ID, model, provider..." x-model="usageLogSearch" @input.debounce.300ms="fetchUsageLog(true)" class="filter-input">
            <select x-model="usageLogModel" @change="fetchUsageLog(true)" class="usage-log-select">
                <option value="">All Models</option>
                <template x-for="m in usageLogModelOptions()" :key="m">
                    <option :value="m" x-text="m"></option>
                </template>
            </select>
            <select x-model="usageLogProvider" @change="fetchUsageLog(true)" class="usage-log-select">
                <option value="">All Providers</option>
                <template x-for="p in usageLogProviderOptions()" :key="p">
                    <option :value="p" x-text="p"></option>
                </template>
            </select>
        </div>
        <div class="table-wrapper" x-show="usageLog.entries.length > 0">
            <table class="data-table usage-log-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Model</th>
                        <th>Provider</th>
                        <th class="col-price" x-text="usageMode === 'costs' ? 'Input Cost' : 'Input'"></th>
                        <th class="col-price" x-text="usageMode === 'costs' ? 'Output Cost' : 'Output'"></th>
                        <th class="col-price" x-text="usageMode === 'costs' ? 'Total Cost' : 'Total'"></th>
                        <th class="col-price" x-show="usageMode === 'tokens'">Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="entry in usageLog.entries" :key="entry.id">
                        <tr>
                            <td class="mono usage-ts" x-text="formatTimestamp(entry.timestamp)"></td>
                            <td class="mono" x-text="entry.model"></td>
                            <td><span class="provider-badge" x-text="entry.provider"></span></td>
                            <td class="col-price"
                                x-text="usageMode === 'costs' ? formatCost(entry.input_cost) : formatNumber(entry.input_tokens)"
                                :title="usageMode === 'costs' ? formatNumber(entry.input_tokens) + ' tokens' : ''"></td>
                            <td class="col-price"
                                x-text="usageMode === 'costs' ? formatCost(entry.output_cost) : formatNumber(entry.output_tokens)"
                                :title="usageMode === 'costs' ? formatNumber(entry.output_tokens) + ' tokens' : ''"></td>
                            <td class="col-price">
                                <span x-text="usageMode === 'costs' ? formatCost(entry.total_cost) : formatNumber(entry.total_tokens)"
                                      :title="usageMode === 'costs' ? formatNumber(entry.total_tokens) + ' tokens\n' + formatCostTooltip(entry) : ''"></span>
                                <span class="caveat-icon" x-show="usageMode === 'costs' && entry.costs_calculation_caveat" :title="entry.costs_calculation_caveat">&#9888;</span>
                            </td>
                            <td class="col-price" x-show="usageMode === 'tokens'"
                                :title="formatCostTooltip(entry)">
                                <span x-text="formatCost(entry.total_cost)"></span>
                                <span class="caveat-icon" x-show="entry.costs_calculation_caveat" :title="entry.costs_calculation_caveat">&#9888;</span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        <p class="empty-state" x-show="usageLog.entries.length === 0 && !loading && !authError">No usage log entries found.</p>
        <!-- Pagination -->
        <div class="pagination" x-show="usageLog.total > 0">
            <span class="pagination-info" x-text="'Showing ' + (usageLog.offset + 1) + '-' + Math.min(usageLog.offset + usageLog.limit, usageLog.total) + ' of ' + usageLog.total"></span>
            <div class="pagination-buttons">
                <button class="pagination-btn" :disabled="usageLog.offset === 0" @click="usageLogPrevPage()">Prev</button>
                <button class="pagination-btn" :disabled="usageLog.offset + usageLog.limit >= usageLog.total" @click="usageLogNextPage()">Next</button>
            </div>
        </div>
    </div>
</div>

<!-- Models Page -->
<div x-show="page==='models'">
    <div class="page-header">
        <h2>Registered Models</h2>
        <div class="model-count" x-show="models.length > 0">
            <span x-text="modelFilter ? filteredModels.length + ' / ' + models.length : models.length"></span> models
        </div>
    </div>

    <!-- Auth Error Banner -->
    <div class="alert alert-warning" x-show="authError">
        Authentication required. Enter your API key in the sidebar to view data.
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs" x-show="categories.length > 0">
        <template x-for="cat in categories" :key="cat.category">
            <button class="category-tab" :class="{ active: activeCategory === cat.category }" @click="selectCategory(cat.category)">
                <span x-text="cat.display_name"></span>
                <span class="tab-count" x-text="cat.count"></span>
            </button>
        </template>
    </div>

    <!-- Filter -->
    <div class="table-toolbar" x-show="models.length > 0 || modelFilter">
        <input type="text" placeholder="Filter by model, provider, or owner..." x-model="modelFilter" class="filter-input">
    </div>

    <!-- Models Table: All / Text Generation -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && (activeCategory === 'all' || activeCategory === 'text_generation')">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th>Modes</th>
                    <th class="col-price">Input $/MTok</th>
                    <th class="col-price">Output $/MTok</th>
                    <th class="col-price" x-show="activeCategory === 'text_generation'">Cached $/MTok</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td x-text="(m.model.metadata?.modes ?? []).join(', ') || '-'"></td>
                        <td class="col-price" x-text="formatPrice(m.model.metadata?.pricing?.input_per_mtok)"></td>
                        <td class="col-price" x-text="formatPrice(m.model.metadata?.pricing?.output_per_mtok)"></td>
                        <td class="col-price" x-show="activeCategory === 'text_generation'" x-text="formatPrice(m.model.metadata?.pricing?.cached_input_per_mtok)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Embeddings -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'embedding'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">Input $/MTok</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPrice(m.model.metadata?.pricing?.input_per_mtok)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Image -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'image'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">$/Image</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_image)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Audio -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'audio'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">$/Second</th>
                    <th class="col-price">$/Character</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_second_input)"></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_character_input)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Video -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'video'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">$/Second (In)</th>
                    <th class="col-price">$/Second (Out)</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_second_input)"></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_second_output)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Utility -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'utility'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">$/Page</th>
                    <th class="col-price">$/Request</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_page)"></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_request)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <p class="empty-state" x-show="models.length === 0 && !loading && !authError && !modelFilter && (activeCategory === 'all' || !activeCategory)">No models registered.</p>
    <p class="empty-state" x-show="models.length === 0 && !loading && !authError && !modelFilter && activeCategory && activeCategory !== 'all'">No models in this category.</p>
    <p class="empty-state" x-show="models.length > 0 && filteredModels.length === 0 && modelFilter">No models match your filter.</p>
</div>
{{end}}
