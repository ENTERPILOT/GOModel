{{define "index"}}
<!-- Overview Page -->
<div x-show="page==='overview'">
    <div class="page-header">
        <h2>Usage Overview</h2>
        <div class="page-header-controls">
            <div class="interval-picker">
                <button class="interval-btn" :class="{active: interval==='daily'}" @click="setInterval('daily')">Daily</button>
                <button class="interval-btn" :class="{active: interval==='weekly'}" @click="setInterval('weekly')">Weekly</button>
                <button class="interval-btn" :class="{active: interval==='monthly'}" @click="setInterval('monthly')">Monthly</button>
                <button class="interval-btn" :class="{active: interval==='yearly'}" @click="setInterval('yearly')">Yearly</button>
            </div>
            {{template "date-picker" .}}
        </div>
    </div>

    <!-- Auth Error Banner -->
    <div class="alert alert-warning" x-show="authError">
        Authentication required. Enter your API key in the sidebar to view data.
    </div>

    <!-- Summary Cards -->
    <div class="cards">
        <div class="card">
            <div class="card-label">Total Requests</div>
            <div class="card-value" x-text="formatNumber(summary.total_requests)">-</div>
        </div>
        <div class="card">
            <div class="card-label">Input Tokens</div>
            <div class="card-value" x-text="formatNumber(summary.total_input_tokens)">-</div>
        </div>
        <div class="card">
            <div class="card-label">Output Tokens</div>
            <div class="card-value" x-text="formatNumber(summary.total_output_tokens)">-</div>
        </div>
        <div class="card">
            <div class="card-label">Total Tokens</div>
            <div class="card-value" x-text="formatNumber(summary.total_tokens)">-</div>
        </div>
        <div class="card">
            <div class="card-label">Estimated Cost</div>
            <div class="card-value" x-text="formatCost(summary.total_cost)">-</div>
        </div>
    </div>

    <!-- Usage Chart -->
    <div class="chart-container">
        <h3 x-text="chartTitle()">Daily Token Usage</h3>
        <div class="chart-wrapper">
            <canvas id="usageChart"></canvas>
        </div>
        <p class="empty-state" x-show="daily.length === 0 && !loading && !authError">No usage data yet.</p>
    </div>
</div>

<!-- Usage Page -->
<div x-show="page==='usage'">
    <div class="page-header">
        <h2>Usage Analytics</h2>
        <div class="page-header-controls">
            <div class="usage-mode-toggle">
                <button class="usage-mode-btn" :class="{active: usageMode==='tokens'}" @click="toggleUsageMode('tokens')">Tokens</button>
                <button class="usage-mode-btn" :class="{active: usageMode==='costs'}" @click="toggleUsageMode('costs')">Costs</button>
            </div>
            {{template "date-picker" .}}
        </div>
    </div>

    <!-- Auth Error Banner -->
    <div class="alert alert-warning" x-show="authError">
        Authentication required. Enter your API key in the sidebar to view data.
    </div>

    <!-- Usage by Model Chart -->
    <div class="model-chart-section" x-show="modelUsage.length > 0">
        <h3 x-text="usageMode === 'tokens' ? 'Token Usage by Model' : 'Cost by Model'"></h3>
        <div class="bar-chart-wrap">
            <canvas id="usageBarChart"></canvas>
        </div>
    </div>

    <!-- Request Log Section -->
    <div class="usage-log-section">
        <h3>Request Log</h3>
        <div class="usage-log-toolbar">
            <input type="text" placeholder="Search by request ID, model, provider..." x-model="usageLogSearch" @input.debounce.300ms="fetchUsageLog(true)" class="filter-input">
            <select x-model="usageLogModel" @change="fetchUsageLog(true)" class="usage-log-select">
                <option value="">All Models</option>
                <template x-for="m in usageLogModelOptions()" :key="m">
                    <option :value="m" x-text="m"></option>
                </template>
            </select>
            <select x-model="usageLogProvider" @change="fetchUsageLog(true)" class="usage-log-select">
                <option value="">All Providers</option>
                <template x-for="p in usageLogProviderOptions()" :key="p">
                    <option :value="p" x-text="p"></option>
                </template>
            </select>
        </div>
        <div class="table-wrapper" x-show="usageLog.entries.length > 0">
            <table class="data-table usage-log-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Model</th>
                        <th>Provider</th>
                        <th class="col-price" x-text="usageMode === 'costs' ? 'Input Cost' : 'Input'"></th>
                        <th class="col-price" x-text="usageMode === 'costs' ? 'Output Cost' : 'Output'"></th>
                        <th class="col-price" x-text="usageMode === 'costs' ? 'Total Cost' : 'Total'"></th>
                        <th class="col-price" x-show="usageMode === 'tokens'">Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="entry in usageLog.entries" :key="entry.id">
                        <tr>
                            <td class="mono usage-ts" x-text="formatTimestamp(entry.timestamp)"></td>
                            <td class="mono" x-text="entry.model"></td>
                            <td><span class="provider-badge" x-text="entry.provider"></span></td>
                            <td class="col-price"
                                x-text="usageMode === 'costs' ? formatCost(entry.input_cost) : formatNumber(entry.input_tokens)"
                                :title="usageMode === 'costs' ? formatNumber(entry.input_tokens) + ' tokens' : ''"></td>
                            <td class="col-price"
                                x-text="usageMode === 'costs' ? formatCost(entry.output_cost) : formatNumber(entry.output_tokens)"
                                :title="usageMode === 'costs' ? formatNumber(entry.output_tokens) + ' tokens' : ''"></td>
                            <td class="col-price">
                                <span x-text="usageMode === 'costs' ? formatCost(entry.total_cost) : formatNumber(entry.total_tokens)"
                                      :title="usageMode === 'costs' ? formatNumber(entry.total_tokens) + ' tokens\n' + formatCostTooltip(entry) : ''"></span>
                                <span class="caveat-icon" x-show="usageMode === 'costs' && entry.costs_calculation_caveat" :title="entry.costs_calculation_caveat">&#9888;</span>
                            </td>
                            <td class="col-price" x-show="usageMode === 'tokens'"
                                :title="formatCostTooltip(entry)">
                                <span x-text="formatCost(entry.total_cost)"></span>
                                <span class="caveat-icon" x-show="entry.costs_calculation_caveat" :title="entry.costs_calculation_caveat">&#9888;</span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        <p class="empty-state" x-show="usageLog.entries.length === 0 && !loading && !authError">No usage log entries found.</p>
        <!-- Pagination -->
        <div class="pagination" x-show="usageLog.total > 0">
            <span class="pagination-info" x-text="'Showing ' + (usageLog.offset + 1) + '-' + Math.min(usageLog.offset + usageLog.limit, usageLog.total) + ' of ' + usageLog.total"></span>
            <div class="pagination-buttons">
                <button class="pagination-btn" :disabled="usageLog.offset === 0" @click="usageLogPrevPage()">Prev</button>
                <button class="pagination-btn" :disabled="usageLog.offset + usageLog.limit >= usageLog.total" @click="usageLogNextPage()">Next</button>
            </div>
        </div>
    </div>
</div>

<!-- Models Page -->
<div x-show="page==='models'">
    <div class="page-header">
        <h2>Registered Models</h2>
        <div class="model-count" x-show="models.length > 0">
            <span x-text="modelFilter ? filteredModels.length + ' / ' + models.length : models.length"></span> models
        </div>
    </div>

    <!-- Auth Error Banner -->
    <div class="alert alert-warning" x-show="authError">
        Authentication required. Enter your API key in the sidebar to view data.
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs" x-show="categories.length > 0">
        <template x-for="cat in categories" :key="cat.category">
            <button class="category-tab" :class="{ active: activeCategory === cat.category }" @click="selectCategory(cat.category)">
                <span x-text="cat.display_name"></span>
                <span class="tab-count" x-text="cat.count"></span>
            </button>
        </template>
    </div>

    <!-- Filter -->
    <div class="table-toolbar" x-show="models.length > 0 || modelFilter">
        <input type="text" placeholder="Filter by model, provider, or owner..." x-model="modelFilter" class="filter-input">
    </div>

    <!-- Models Table: All / Text Generation -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && (activeCategory === 'all' || activeCategory === 'text_generation')">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th>Modes</th>
                    <th class="col-price">Input $/MTok</th>
                    <th class="col-price">Output $/MTok</th>
                    <th class="col-price" x-show="activeCategory === 'text_generation'">Cached $/MTok</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td x-text="(m.model.metadata?.modes ?? []).join(', ') || '-'"></td>
                        <td class="col-price" x-text="formatPrice(m.model.metadata?.pricing?.input_per_mtok)"></td>
                        <td class="col-price" x-text="formatPrice(m.model.metadata?.pricing?.output_per_mtok)"></td>
                        <td class="col-price" x-show="activeCategory === 'text_generation'" x-text="formatPrice(m.model.metadata?.pricing?.cached_input_per_mtok)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Embeddings -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'embedding'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">Input $/MTok</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPrice(m.model.metadata?.pricing?.input_per_mtok)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Image -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'image'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">$/Image</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_image)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Audio -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'audio'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">$/Second</th>
                    <th class="col-price">$/Character</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_second_input)"></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_character_input)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Video -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'video'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">$/Second (In)</th>
                    <th class="col-price">$/Second (Out)</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_second_input)"></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_second_output)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Models Table: Utility -->
    <div class="table-wrapper" x-show="(models.length > 0 || modelFilter) && activeCategory === 'utility'">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Model ID</th>
                    <th>Provider</th>
                    <th class="col-price">$/Page</th>
                    <th class="col-price">$/Request</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="m in filteredModels" :key="m.model.id">
                    <tr>
                        <td class="mono" x-text="m.model.id"></td>
                        <td><span class="provider-badge" x-text="m.provider_type"></span></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_page)"></td>
                        <td class="col-price" x-text="formatPriceFine(m.model.metadata?.pricing?.per_request)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <p class="empty-state" x-show="models.length === 0 && !loading && !authError && !modelFilter && (activeCategory === 'all' || !activeCategory)">No models registered.</p>
    <p class="empty-state" x-show="models.length === 0 && !loading && !authError && !modelFilter && activeCategory && activeCategory !== 'all'">No models in this category.</p>
    <p class="empty-state" x-show="models.length > 0 && filteredModels.length === 0 && modelFilter">No models match your filter.</p>
</div>

<!-- Audit Logs Page -->
<div x-show="page==='audit'">
    <div class="page-header">
        <h2>Audit Logs</h2>
        <div class="page-header-controls">
            {{template "date-picker" .}}
        </div>
    </div>

    <!-- Auth Error Banner -->
    <div class="alert alert-warning" x-show="authError">
        Authentication required. Enter your API key in the sidebar to view data.
    </div>

    <div class="audit-log-section">
        <div class="audit-log-toolbar">
            <div class="audit-filter-row">
                <input type="text" placeholder="Search by request ID, path, provider, error..." x-model="auditSearch" @input.debounce.300ms="fetchAuditLog(true)" class="filter-input">
                <input type="text" placeholder="Model" x-model="auditModel" @input.debounce.300ms="fetchAuditLog(true)" class="filter-input audit-filter-input">
                <input type="text" placeholder="Provider" x-model="auditProvider" @input.debounce.300ms="fetchAuditLog(true)" class="filter-input audit-filter-input">
                <input type="text" placeholder="Path" x-model="auditPath" @input.debounce.300ms="fetchAuditLog(true)" class="filter-input audit-filter-input">
                <button class="pagination-btn" @click="clearAuditFilters()">Clear</button>
            </div>
            <div class="audit-filter-row audit-filter-row-selects">
                <select x-model="auditMethod" @change="fetchAuditLog(true)" class="usage-log-select audit-filter-select">
                    <option value="">All Methods</option>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <select x-model="auditStatusCode" @change="fetchAuditLog(true)" class="usage-log-select audit-filter-select">
                    <option value="">All Statuses</option>
                    <option value="200">200</option>
                    <option value="201">201</option>
                    <option value="400">400</option>
                    <option value="401">401</option>
                    <option value="403">403</option>
                    <option value="404">404</option>
                    <option value="429">429</option>
                    <option value="500">500</option>
                    <option value="502">502</option>
                    <option value="503">503</option>
                </select>
                <select x-model="auditStream" @change="fetchAuditLog(true)" class="usage-log-select audit-filter-select">
                    <option value="">All Modes</option>
                    <option value="true">Streaming</option>
                    <option value="false">Non-streaming</option>
                </select>
            </div>
        </div>

        <p class="audit-log-summary" x-show="auditLog.total > 0" x-text="'Showing ' + (auditLog.offset + 1) + '-' + Math.min(auditLog.offset + auditLog.limit, auditLog.total) + ' of ' + auditLog.total + ' logs'"></p>

        <div class="audit-log-list" x-show="auditLog.entries.length > 0">
            <template x-for="entry in auditLog.entries" :key="entry.id">
                <details class="audit-entry">
                    <summary class="audit-entry-summary">
                        <div class="audit-entry-main">
                            <span class="audit-status-badge" :class="statusCodeClass(entry.status_code)" x-text="entry.status_code || '-'"></span>
                            <span class="audit-method-badge" x-text="entry.method || '-'"></span>
                            <span class="audit-path mono" x-text="entry.path || '-'"></span>
                        </div>
                        <div class="audit-entry-meta">
                            <span class="mono" x-text="formatTimestamp(entry.timestamp)"></span>
                            <span class="mono" x-text="formatDurationNs(entry.duration_ns)"></span>
                            <button class="audit-conversation-trigger"
                                    x-show="canShowConversation(entry)"
                                    title="Open conversation"
                                    @click.stop.prevent="openConversation(entry, $el.closest('details'), true)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 6l6 6-6 6"/>
                                </svg>
                            </button>
                        </div>
                    </summary>
                    <div class="audit-entry-details">
                        <div class="audit-entry-context">
                            <span class="provider-badge" x-text="entry.provider || '-'"></span>
                            <span class="provider-badge mono" x-text="entry.model || '-'"></span>
                            <span class="provider-badge mono" x-text="'request_id: ' + (entry.request_id || '-')"></span>
                            <span class="provider-badge mono" x-show="entry.client_ip" x-text="'ip: ' + entry.client_ip"></span>
                            <span class="provider-badge" x-show="entry.stream">stream</span>
                            <span class="provider-badge" x-show="entry.error_type" x-text="entry.error_type"></span>
                        </div>

                        <div class="audit-request-response">
                            <section class="audit-pane">
                                <div class="audit-pane-head">
                                    <h4>Request</h4>
                                    <button class="pagination-btn" @click.prevent="copyAuditJSON(entry.data && entry.data.request_body)">Copy Body</button>
                                </div>
                                <div class="audit-pane-block" x-show="entry.data && entry.data.request_headers">
                                    <h5>Headers</h5>
                                    <pre class="audit-json" x-text="formatJSON(entry.data.request_headers)"></pre>
                                </div>
                                <div class="audit-pane-block" x-show="entry.data && entry.data.request_body">
                                    <h5>Body</h5>
                                    <pre class="audit-json audit-json-body"
                                         x-html="renderBodyWithConversationHighlights(entry, entry.data.request_body)"
                                         @mousedown="startBodyInteraction($event)"
                                         @click="handleBodyConversationClick($event, entry)"></pre>
                                </div>
                                <p class="empty-state audit-pane-empty" x-show="!entry.data || (!entry.data.request_headers && !entry.data.request_body)">Request details were not captured.</p>
                                <p class="audit-size-warning" x-show="entry.data && entry.data.request_body_too_big_to_handle">Request body was too large to capture.</p>
                            </section>

                            <section class="audit-pane">
                                <div class="audit-pane-head">
                                    <h4>Response</h4>
                                    <button class="pagination-btn" @click.prevent="copyAuditJSON(entry.data && entry.data.response_body)">Copy Body</button>
                                </div>
                                <div class="audit-pane-block" x-show="entry.data && entry.data.error_message">
                                    <h5>Error Message</h5>
                                    <pre class="audit-json" x-text="entry.data.error_message"></pre>
                                </div>
                                <div class="audit-pane-block" x-show="entry.data && entry.data.response_headers">
                                    <h5>Headers</h5>
                                    <pre class="audit-json" x-text="formatJSON(entry.data.response_headers)"></pre>
                                </div>
                                <div class="audit-pane-block" x-show="entry.data && entry.data.response_body">
                                    <h5>Body</h5>
                                    <pre class="audit-json audit-json-body"
                                         x-html="renderBodyWithConversationHighlights(entry, entry.data.response_body)"
                                         @mousedown="startBodyInteraction($event)"
                                         @click="handleBodyConversationClick($event, entry)"></pre>
                                </div>
                                <p class="empty-state audit-pane-empty" x-show="!entry.data || (!entry.data.error_message && !entry.data.response_headers && !entry.data.response_body)">Response details were not captured.</p>
                                <p class="audit-size-warning" x-show="entry.data && entry.data.response_body_too_big_to_handle">Response body was too large to capture.</p>
                            </section>
                        </div>
                    </div>
                </details>
            </template>
        </div>

        <p class="empty-state" x-show="auditLog.entries.length === 0 && !loading && !authError">No audit log entries found.</p>

        <div class="pagination" x-show="auditLog.total > 0">
            <span class="pagination-info" x-text="'Showing ' + (auditLog.offset + 1) + '-' + Math.min(auditLog.offset + auditLog.limit, auditLog.total) + ' of ' + auditLog.total"></span>
            <div class="pagination-buttons">
                <button class="pagination-btn" :disabled="auditLog.offset === 0" @click="auditLogPrevPage()">Prev</button>
                <button class="pagination-btn" :disabled="auditLog.offset + auditLog.limit >= auditLog.total" @click="auditLogNextPage()">Next</button>
            </div>
        </div>
    </div>

    <div class="conversation-overlay" x-show="conversationOpen" x-transition.opacity.duration.160ms @click="closeConversation()"></div>
    <aside class="conversation-drawer" :class="{ open: conversationOpen }">
        <div class="conversation-drawer-header">
            <h3>Conversation</h3>
            <button class="pagination-btn" @click="closeConversation()">Close</button>
        </div>

        <div class="alert alert-warning" x-show="conversationError" x-text="conversationError"></div>
        <p class="empty-state" x-show="conversationLoading">Loading conversation...</p>
        <p class="empty-state" x-show="!conversationLoading && !conversationError && conversationMessages.length === 0">No conversation data available for this entry.</p>

        <div class="conversation-thread" x-show="conversationMessages.length > 0">
            <template x-for="msg in conversationMessages" :key="msg.uid">
                <article class="chat-message" :class="[msg.roleClass, msg.isAnchor ? 'is-anchor' : '']">
                    <header class="chat-message-meta">
                        <span class="chat-role" x-text="msg.roleLabel"></span>
                        <span class="mono chat-time" x-text="formatTimestamp(msg.timestamp)"></span>
                    </header>
                    <pre class="chat-content" x-text="msg.text"></pre>
                </article>
            </template>
        </div>

        <div class="conversation-drawer-footer" x-show="conversationAnchorID">
            <p class="conversation-meta" x-text="'Opened from log: ' + conversationAnchorID"></p>
        </div>
    </aside>
</div>
{{end}}
